<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>S√©lecteur d'Images par Niveau</title>
    <style>
        body {
            font-family: 'FreeMono', monospace;
            margin: 20px;
            background: linear-gradient(135deg, #87CEEB 0%, #87CEFA 100%);
            min-height: 100vh;
            color: white;
            text-shadow: 1px 1px 0px black;
            text-transform: uppercase;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 2px solid cyan;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            text-shadow: 1px 1px 0px black;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .level-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid cyan;
            transition: all 0.3s ease;
        }

        .level-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .level-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            color: white;
            text-shadow: 1px 1px 0px black;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
        }

        .image-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .image-option {
            position: relative;
            cursor: pointer;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 3px solid cyan;
        }

        .image-option:hover {
            transform: scale(1.05);
        }

        .image-option.selected {
            border-color: white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }

        .image-option img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            display: block;
        }

        .image-option .image-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 8px;
            padding: 2px 4px;
            text-align: center;
            text-shadow: 1px 1px 0px black;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
        }

        .controls {
            text-align: center;
            margin-top: 30px;
        }

        .btn {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            border: 2px solid cyan;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 1px 1px 0px black;
            font-family: 'FreeMono', monospace;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
        }

        .btn.secondary:hover {
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .current-selection {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid cyan;
        }

        .current-selection h3 {
            margin-top: 0;
            color: white;
            text-shadow: 1px 1px 0px black;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            font-size: 12px;
        }

        .selection-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid cyan;
            color: white;
            text-shadow: 1px 1px 0px black;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
        }

        .selection-item img {
            width: 30px;
            height: 30px;
            border-radius: 5px;
        }

        .available-images {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .available-image {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: 2px solid cyan;
        }

        .available-image:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .available-image img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .available-image .name {
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 0px black;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
        }

        /* Styles pour l'upload d'images personnalis√©es */
        .custom-upload-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #ff6b35;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .custom-upload-section h3 {
            color: #ff6b35;
            text-align: center;
            margin-bottom: 20px;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
            text-shadow: 1px 1px 0px black;
        }

        .upload-area {
            border: 3px dashed #ff6b35;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: rgba(255, 107, 53, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: rgba(255, 107, 53, 0.2);
            border-color: #ff8c69;
        }

        .upload-area.dragover {
            background: rgba(255, 107, 53, 0.3);
            border-color: #ff4500;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #ff6b35;
            margin-bottom: 15px;
        }

        .upload-text {
            color: white;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: rgba(255, 255, 255, 0.7);
            font-family: 'FreeMono', monospace;
            font-size: 12px;
        }

        .custom-images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .custom-image-item {
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            border: 2px solid #ff6b35;
            transition: all 0.3s ease;
        }

        .custom-image-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .custom-image-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .custom-image-item .name {
            font-size: 10px;
            color: white;
            text-align: center;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
            word-break: break-all;
        }

        .delete-custom-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .delete-custom-image:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        .upload-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .upload-btn {
            background: linear-gradient(45deg, #ff6b35, #ff8c69);
            border: 2px solid #ff6b35;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-family: 'FreeMono', monospace;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4);
        }

        .upload-btn.secondary {
            background: linear-gradient(45deg, #666, #888);
            border-color: #666;
        }

        .upload-btn.secondary:hover {
            box-shadow: 0 5px 15px rgba(102, 102, 102, 0.4);
        }

        #customImageInput {
            display: none;
        }

        .processing-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 10000;
            font-family: 'FreeMono', monospace;
            text-transform: uppercase;
        }

        .processing-indicator .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b35;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® S√©lecteur d'Images par Niveau</h1>
        
        <div class="current-selection">
            <h3>Configuration Actuelle</h3>
            <div class="selection-grid" id="currentSelection"></div>
        </div>

        <!-- Section d'upload d'images personnalis√©es -->
        <div class="custom-upload-section">
            <h3>üì§ Ajouter vos propres images</h3>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Cliquez ici ou glissez-d√©posez vos images</div>
                <div class="upload-subtext">Formats support√©s: PNG, JPG, JPEG, GIF, WEBP<br>
                Conversion automatique en PNG 640x640<br>
                Meilleur effet en noir et blanc</div>
            </div>
            
            <div class="upload-controls">
                <button class="upload-btn" onclick="selectCustomImages()">
                    üìÇ Parcourir les fichiers
                </button>
                <button class="upload-btn secondary" onclick="clearAllCustomImages()">
                    üóëÔ∏è Supprimer toutes les images personnalis√©es
                </button>
                <button class="upload-btn" onclick="toggleBackgroundRemoval()" id="bgRemovalToggle" style="background: linear-gradient(45deg, #9c27b0, #e91e63);">
                    üé≠ Suppression de fond: OFF
                </button>
            </div>
            
            <div class="custom-images-grid" id="customImagesGrid"></div>
            
            <input type="file" id="customImageInput" multiple accept="image/*">
        </div>

        <h3>Images Disponibles</h3>
        <div class="available-images" id="availableImages"></div>

        <div class="level-grid" id="levelGrid"></div>

        <div class="controls">
            <button class="btn" onclick="applyConfiguration()">Appliquer la Configuration</button>
            <button class="btn secondary" onclick="resetToDefault()">R√©initialiser</button>
            <button class="btn" onclick="applyToAll()" style="background: linear-gradient(45deg, #9c27b0, #e91e63);">üéØ Appliquer sur tout</button>
            <button class="btn" onclick="randomizeAllLevels()" style="background: linear-gradient(45deg, #ff9800, #ffc107);">üé≤ Al√©atoire</button>
        </div>

        <input type="file" id="configFileInput" accept=".json" style="display: none;">
    </div>

    <!-- Indicateur de traitement -->
    <div id="processingIndicator" class="processing-indicator" style="display: none;">
        <div class="spinner"></div>
        <div>Traitement de l'image...</div>
        <div style="font-size: 12px; margin-top: 10px;">Conversion en PNG 640x640</div>
    </div>

    <script>
        // Configuration par d√©faut bas√©e sur les donn√©es
        const defaultConfiguration = {
            1: "1blackhole.png",
            2: "2blackhole.png", 
            3: "3whitehole.png",
            4: "4nebuleuse.png",
            5: "5etoile.png",
            6: "6etoile.png",
            7: "7neutronstar.png",
            8: "8planet.png",
            9: "9planet.png",
            10: "10protoplanet.png",
            11: "11moon.png",
            12: "12asteroid.png",
            13: "13asteroid.png"
        };

        // Images disponibles
        const availableImages = [
            "1blackhole.png",
            "2blackhole.png",
            "3whitehole.png",
            "4nebuleuse.png",
            "5etoile.png",
            "6etoile.png",
            "7neutronstar.png",
            "8planet.png",
            "9planet.png",
            "10protoplanet.png",
            "11moon.png",
            "12asteroid.png",
            "13asteroid.png",
            "whoz_logo.png",
            "bubble.png",
            "links.png",
            "atos_logo.png",
            "mckinsey_logo.png",
            "capgemini_logo.png",
            "airbus_logo.png",
            "akkodis_logo.png",
            "aubay_logo.png",
            "ayming_logo.png",
            "consortgroups_logo.png",
            "devoteam_logo.png",
            "econocom_logo.png",
            "egis_logo.png",
            "keyrus_logo.png",
            "mc2i_logo.png",
            "open_logo.png",
            "orange_logo.png",
            "sm4rt4_logo.png",
            "sqli_logo.png"
        ];

        // Images personnalis√©es stock√©es dans localStorage
        let customImages = [];

        // Configuration actuelle
        let currentConfiguration = { ...defaultConfiguration };

        // Charger la configuration sauvegard√©e avec migration automatique
        function loadSavedConfiguration() {
            const saved = localStorage.getItem('spriteImageConfig');
            if (saved) {
                try {
                    const loadedConfig = JSON.parse(saved);
                    let needsMigration = false;
                    
                    // Migrer les anciennes configurations avec noms de fichiers vers data URLs
                    for (let level = 1; level <= 13; level++) {
                        const configValue = loadedConfig[level];
                        
                        if (configValue && configValue.startsWith('custom_') && !configValue.startsWith('data:')) {
                            // C'est un ancien nom de fichier d'image personnalis√©e
                            const customImage = customImages.find(img => img.name === configValue);
                            if (customImage) {
                                loadedConfig[level] = customImage.dataUrl;
                                needsMigration = true;
                                console.log(`üîÑ Migration niveau ${level}: ${configValue} -> data URL`);
                            } else {
                                // Image personnalis√©e non trouv√©e, utiliser l'image par d√©faut
                                loadedConfig[level] = defaultConfiguration[level];
                                needsMigration = true;
                                console.warn(`‚ö†Ô∏è Image personnalis√©e ${configValue} non trouv√©e pour le niveau ${level}, utilisation de l'image par d√©faut`);
                            }
                        }
                    }
                    
                    // Sauvegarder la configuration migr√©e
                    if (needsMigration) {
                        localStorage.setItem('spriteImageConfig', JSON.stringify(loadedConfig));
                        console.log('‚úÖ Configuration migr√©e et sauvegard√©e');
                    }
                    
                    // Valider et nettoyer la configuration
                    const allImages = getAllAvailableImages();
                    for (let level = 1; level <= 13; level++) {
                        const configValue = loadedConfig[level];
                        
                        if (configValue && (configValue.startsWith('data:') || allImages.includes(configValue))) {
                            currentConfiguration[level] = configValue;
                        } else {
                            // Si l'image n'est plus disponible, utiliser l'image par d√©faut
                            currentConfiguration[level] = defaultConfiguration[level];
                            console.warn(`Image ${configValue} non disponible pour le niveau ${level}, utilisation de l'image par d√©faut`);
                        }
                    }
                } catch (e) {
                    console.error('Erreur lors du chargement de la configuration:', e);
                }
            }
        }

        // Sauvegarder la configuration
        function saveConfiguration() {
            localStorage.setItem('spriteImageConfig', JSON.stringify(currentConfiguration));
        }

        // Charger les images personnalis√©es depuis localStorage
        function loadCustomImages() {
            try {
                const saved = localStorage.getItem('customImages');
                if (saved) {
                    customImages = JSON.parse(saved);
                    console.log(`Charg√© ${customImages.length} images personnalis√©es`);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des images personnalis√©es:', error);
                customImages = [];
            }
        }

        // Sauvegarder les images personnalis√©es dans localStorage
        function saveCustomImages() {
            try {
                localStorage.setItem('customImages', JSON.stringify(customImages));
                console.log(`Sauvegard√© ${customImages.length} images personnalis√©es`);
            } catch (error) {
                console.error('Erreur lors de la sauvegarde des images personnalis√©es:', error);
                if (error.name === 'QuotaExceededError') {
                    alert('Espace de stockage insuffisant. Veuillez supprimer quelques images personnalis√©es.');
                }
            }
        }

        // Obtenir toutes les images disponibles (pr√©d√©finies + personnalis√©es)
        function getAllAvailableImages() {
            return [...availableImages, ...customImages.map(img => img.name)];
        }

        // Initialiser l'interface
        function initializeInterface() {
            loadCustomImages();
            loadSavedConfiguration();
            createAvailableImagesDisplay();
            createCustomImagesDisplay();
            createLevelSelectors();
            updateCurrentSelection();
            setupUploadHandlers();
        }

        // Cr√©er l'affichage des images disponibles
        function createAvailableImagesDisplay() {
            const container = document.getElementById('availableImages');
            container.innerHTML = '';

            availableImages.forEach(imageName => {
                const div = document.createElement('div');
                div.className = 'available-image';
                
                const img = document.createElement('img');
                img.src = imageName;
                img.alt = imageName;
                img.onerror = function() {
                    this.style.background = '#666';
                    this.style.color = 'white';
                    this.style.display = 'flex';
                    this.style.alignItems = 'center';
                    this.style.justifyContent = 'center';
                    this.textContent = '?';
                };

                const name = document.createElement('div');
                name.className = 'name';
                name.textContent = imageName.replace('.png', '');

                div.appendChild(img);
                div.appendChild(name);
                container.appendChild(div);
            });
        }

        // Cr√©er l'affichage des images personnalis√©es
        function createCustomImagesDisplay() {
            const container = document.getElementById('customImagesGrid');
            container.innerHTML = '';

            customImages.forEach((customImage, index) => {
                const div = document.createElement('div');
                div.className = 'custom-image-item';
                
                const img = document.createElement('img');
                img.src = customImage.dataUrl;
                img.alt = customImage.name;
                img.onerror = function() {
                    this.style.background = '#666';
                    this.style.color = 'white';
                    this.style.display = 'flex';
                    this.style.alignItems = 'center';
                    this.style.justifyContent = 'center';
                    this.textContent = '?';
                };

                const name = document.createElement('div');
                name.className = 'name';
                name.textContent = customImage.originalName.replace(/\.[^/.]+$/, '');

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-custom-image';
                deleteBtn.innerHTML = '√ó';
                deleteBtn.title = 'Supprimer cette image';
                deleteBtn.onclick = () => deleteCustomImage(index);

                div.appendChild(img);
                div.appendChild(name);
                div.appendChild(deleteBtn);
                container.appendChild(div);
            });
        }

        // Cr√©er les s√©lecteurs pour chaque niveau
        function createLevelSelectors() {
            const container = document.getElementById('levelGrid');
            container.innerHTML = '';

            for (let level = 1; level <= 13; level++) {
                const card = document.createElement('div');
                card.className = 'level-card';

                const title = document.createElement('div');
                title.className = 'level-title';
                title.textContent = `Niveau ${level}`;

                const selector = document.createElement('div');
                selector.className = 'image-selector';

                // Afficher les images pr√©d√©finies
                availableImages.forEach(imageName => {
                    const option = createImageOption(imageName, imageName, level, selector);
                    selector.appendChild(option);
                });

                // Afficher les images personnalis√©es
                customImages.forEach(customImage => {
                    const option = createImageOption(customImage.name, customImage.dataUrl, level, selector, true);
                    selector.appendChild(option);
                });

                card.appendChild(title);
                card.appendChild(selector);
                container.appendChild(card);
            }
        }

        // Cr√©er une option d'image (pour les images pr√©d√©finies et personnalis√©es)
        function createImageOption(imageName, imageSrc, level, selector, isCustom = false) {
            const option = document.createElement('div');
            option.className = 'image-option';
            
            // V√©rifier si cette option est s√©lectionn√©e
            let isSelected = false;
            if (isCustom) {
                // Pour les images personnalis√©es, v√©rifier si le data URL correspond
                const customImage = customImages.find(img => img.name === imageName);
                if (customImage && currentConfiguration[level] === customImage.dataUrl) {
                    isSelected = true;
                }
            } else {
                // Pour les images pr√©d√©finies, v√©rifier le nom
                if (currentConfiguration[level] === imageName) {
                    isSelected = true;
                }
            }
            
            if (isSelected) {
                option.classList.add('selected');
            }

            const img = document.createElement('img');
            img.src = imageSrc;
            img.alt = imageName;
            img.onerror = function() {
                this.style.background = '#666';
                this.style.color = 'white';
                this.style.display = 'flex';
                this.style.alignItems = 'center';
                this.style.justifyContent = 'center';
                this.textContent = '?';
            };

            const name = document.createElement('div');
            name.className = 'image-name';
            name.textContent = isCustom ? 
                imageName.replace(/^custom_/, '').replace(/\.[^/.]+$/, '') : 
                imageName.replace('.png', '');

            // Ajouter un indicateur pour les images personnalis√©es
            if (isCustom) {
                name.style.color = '#ff6b35';
                name.textContent = '‚òÖ ' + name.textContent;
            }

            option.appendChild(img);
            option.appendChild(name);

            option.addEventListener('click', () => {
                // D√©s√©lectionner les autres options de ce niveau
                selector.querySelectorAll('.image-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // S√©lectionner cette option
                option.classList.add('selected');
                
                // Pour les images personnalis√©es, sauvegarder le data URL directement
                if (isCustom) {
                    const customImage = customImages.find(img => img.name === imageName);
                    if (customImage) {
                        currentConfiguration[level] = customImage.dataUrl;
                        console.log(`üé® Image personnalis√©e s√©lectionn√©e pour niveau ${level}: data URL sauvegard√©`);
                    } else {
                        currentConfiguration[level] = imageName;
                    }
                } else {
                    // Pour les images pr√©d√©finies, sauvegarder le nom de fichier
                    currentConfiguration[level] = imageName;
                    console.log(`üìÅ Image pr√©d√©finie s√©lectionn√©e pour niveau ${level}: ${imageName}`);
                }
                
                updateCurrentSelection();
                saveConfiguration();
            });

            return option;
        }

        // Mettre √† jour l'affichage de la s√©lection actuelle
        function updateCurrentSelection() {
            const container = document.getElementById('currentSelection');
            container.innerHTML = '';

            for (let level = 1; level <= 13; level++) {
                const item = document.createElement('div');
                item.className = 'selection-item';

                const img = document.createElement('img');
                const configValue = currentConfiguration[level];
                
                let imageSrc, displayName;
                
                // V√©rifier si c'est un data URL (image personnalis√©e)
                if (configValue && configValue.startsWith('data:')) {
                    imageSrc = configValue;
                    // Trouver l'image personnalis√©e correspondante pour le nom d'affichage
                    const customImage = customImages.find(ci => ci.dataUrl === configValue);
                    displayName = customImage ?
                        '‚òÖ ' + customImage.originalName.replace(/\.[^/.]+$/, '') :
                        '‚òÖ Image personnalis√©e';
                } else {
                    // V√©rifier si c'est une image personnalis√©e par nom
                    const customImage = customImages.find(ci => ci.name === configValue);
                    if (customImage) {
                        imageSrc = customImage.dataUrl;
                        displayName = '‚òÖ ' + customImage.originalName.replace(/\.[^/.]+$/, '');
                    } else {
                        // Image pr√©d√©finie
                        imageSrc = configValue;
                        displayName = configValue.replace('.png', '');
                    }
                }
                
                img.src = imageSrc;
                img.alt = configValue;
                img.onerror = function() {
                    this.style.background = '#666';
                    this.style.color = 'white';
                    this.style.display = 'flex';
                    this.style.alignItems = 'center';
                    this.style.justifyContent = 'center';
                    this.textContent = '?';
                };

                const text = document.createElement('span');
                text.textContent = `Niveau ${level}: ${displayName}`;

                item.appendChild(img);
                item.appendChild(text);
                container.appendChild(item);
            }
        }

        // Appliquer la configuration (mettre √† jour les donn√©es JSON)
        function applyConfiguration() {
            saveConfiguration();
            
            // Essayer de communiquer avec l'application principale
            try {
                // Si l'application principale est ouverte dans une autre fen√™tre
                if (window.opener && window.opener.reloadWithNewImageConfiguration) {
                    window.opener.reloadWithNewImageConfiguration();
                    alert('Configuration appliqu√©e avec succ√®s !\nLes changements sont visibles dans l\'application principale.');
                } else {
                    // D√©clencher un √©v√©nement storage pour notifier les autres onglets
                    localStorage.setItem('spriteImageConfigUpdate', Date.now().toString());
                    
                    const message = `Configuration appliqu√©e et sauvegard√©e !\n\nPour voir les changements :\n‚Ä¢ Si l'application principale est ouverte, elle se mettra √† jour automatiquement\n‚Ä¢ Sinon, ouvrez ou rechargez l'application principale`;
                    alert(message);
                }
            } catch (error) {
                console.error('Erreur lors de l\'application:', error);
                alert('Configuration sauvegard√©e ! Rechargez l\'application principale pour voir les changements.');
            }
        }

        // R√©initialiser √† la configuration par d√©faut
        function resetToDefault() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser √† la configuration par d√©faut ?')) {
                currentConfiguration = { ...defaultConfiguration };
                saveConfiguration();
                createLevelSelectors();
                updateCurrentSelection();
            }
        }

        // Exporter la configuration
        function exportConfiguration() {
            const dataStr = JSON.stringify(currentConfiguration, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'image_configuration.json';
            link.click();
        }

        // Importer une configuration
        function importConfiguration() {
            document.getElementById('configFileInput').click();
        }

        // Gestionnaire pour l'import de fichier
        document.getElementById('configFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const imported = JSON.parse(e.target.result);
                        
                        // Valider la configuration import√©e
                        let valid = true;
                        const allImages = getAllAvailableImages();
                        for (let level = 1; level <= 13; level++) {
                            if (!imported[level] || !allImages.includes(imported[level])) {
                                valid = false;
                                break;
                            }
                        }
                        
                        if (valid) {
                            currentConfiguration = imported;
                            saveConfiguration();
                            createLevelSelectors();
                            updateCurrentSelection();
                            alert('Configuration import√©e avec succ√®s !');
                        } else {
                            alert('Fichier de configuration invalide !');
                        }
                    } catch (error) {
                        alert('Erreur lors de l\'import : ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // Initialiser l'interface au chargement de la page
        document.addEventListener('DOMContentLoaded', initializeInterface);

        // Fonction pour appliquer imm√©diatement les changements
        function applyImmediately() {
            saveConfiguration();
            
            // D√©clencher l'√©v√©nement de mise √† jour
            localStorage.setItem('spriteImageConfigUpdate', Date.now().toString());
            
            // Essayer de mettre √† jour l'application principale directement
            try {
                if (window.opener && window.opener.reloadWithNewImageConfiguration) {
                    window.opener.reloadWithNewImageConfiguration();
                    alert('‚úÖ Configuration appliqu√©e imm√©diatement !\nLes changements sont visibles dans l\'application principale.');
                } else {
                    alert('‚ö° Configuration sauvegard√©e !\nSi l\'application principale est ouverte, elle se mettra √† jour automatiquement.');
                }
            } catch (error) {
                console.log('Application principale non accessible directement');
                alert('‚ö° Configuration sauvegard√©e !\nRechargez l\'application principale pour voir les changements.');
            }
        }

        // Fonction pour appliquer une image √† tous les niveaux
        function applyToAll() {
            // Cr√©er une liste d'options pour le s√©lecteur (images pr√©d√©finies + personnalis√©es)
            let options = '';
            
            // Images pr√©d√©finies
            availableImages.forEach(imageName => {
                options += `<option value="${imageName}">${imageName.replace('.png', '')}</option>`;
            });
            
            // Images personnalis√©es
            customImages.forEach(customImage => {
                options += `<option value="${customImage.name}">‚òÖ ${customImage.originalName.replace(/\.[^/.]+$/, '')}</option>`;
            });
            
            // Cr√©er le HTML du s√©lecteur
            const selectorHTML = `
                <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.8); color: white; border-radius: 10px;">
                    <h3 style="margin-top: 0; color: white; text-shadow: 1px 1px 0px black; font-family: 'FreeMono', monospace; text-transform: uppercase;">
                        üéØ Choisir une image pour tous les niveaux
                    </h3>
                    <select id="imageSelector" style="padding: 10px; font-size: 16px; border-radius: 5px; margin: 10px; background: white; color: black; font-family: 'FreeMono', monospace;">
                        ${options}
                    </select>
                    <br><br>
                    <button onclick="confirmApplyToAll()" style="background: linear-gradient(45deg, #00ff88, #00d4ff); border: 2px solid cyan; color: white; padding: 10px 20px; border-radius: 15px; cursor: pointer; font-size: 14px; font-weight: bold; margin: 5px; text-transform: uppercase; font-family: 'FreeMono', monospace;">
                        ‚úÖ Confirmer
                    </button>
                    <button onclick="cancelApplyToAll()" style="background: linear-gradient(45deg, #ff6b6b, #ffa500); border: 2px solid orange; color: white; padding: 10px 20px; border-radius: 15px; cursor: pointer; font-size: 14px; font-weight: bold; margin: 5px; text-transform: uppercase; font-family: 'FreeMono', monospace;">
                        ‚ùå Annuler
                    </button>
                </div>
            `;
            
            // Cr√©er et afficher le modal
            const modal = document.createElement('div');
            modal.id = 'applyToAllModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;
            modal.innerHTML = selectorHTML;
            document.body.appendChild(modal);
        }
        
        // Confirmer l'application √† tous les niveaux
        function confirmApplyToAll() {
            const selectedImage = document.getElementById('imageSelector').value;
            
            // D√©terminer la valeur √† sauvegarder (data URL pour les images personnalis√©es)
            let valueToSave = selectedImage;
            const customImage = customImages.find(ci => ci.name === selectedImage);
            if (customImage) {
                valueToSave = customImage.dataUrl;
                console.log(`üéØ Application d'une image personnalis√©e √† tous les niveaux: data URL sauvegard√©`);
            } else {
                console.log(`üìÅ Application d'une image pr√©d√©finie √† tous les niveaux: ${selectedImage}`);
            }
            
            // Appliquer la valeur √† tous les niveaux
            for (let level = 1; level <= 13; level++) {
                currentConfiguration[level] = valueToSave;
            }
            
            // Sauvegarder et mettre √† jour l'interface
            saveConfiguration();
            createLevelSelectors();
            updateCurrentSelection();
            
            // Fermer le modal
            cancelApplyToAll();
            
            const displayName = customImage?.originalName.replace(/\.[^/.]+$/, '') || selectedImage.replace('.png', '');
            alert(`‚úÖ Image "${displayName}" appliqu√©e √† tous les niveaux !`);
        }
        
        // Annuler l'application √† tous les niveaux
        function cancelApplyToAll() {
            const modal = document.getElementById('applyToAllModal');
            if (modal) {
                modal.remove();
            }
        }

        // Fonction pour randomiser toutes les images
        function randomizeAllLevels() {
            if (confirm('üé≤ Voulez-vous vraiment appliquer des images al√©atoires √† tous les niveaux ?\n\nCela remplacera votre configuration actuelle.')) {
                // Obtenir toutes les images disponibles (pr√©d√©finies + personnalis√©es)
                const allImages = [...availableImages];
                
                // Ajouter les images personnalis√©es avec leurs data URLs
                customImages.forEach(customImage => {
                    allImages.push({
                        name: customImage.name,
                        dataUrl: customImage.dataUrl,
                        isCustom: true
                    });
                });
                
                if (allImages.length === 0) {
                    alert('‚ùå Aucune image disponible pour la randomisation');
                    return;
                }
                
                let changedLevels = 0;
                
                // Appliquer une image al√©atoire √† chaque niveau
                for (let level = 1; level <= 13; level++) {
                    const randomIndex = Math.floor(Math.random() * allImages.length);
                    const selectedImage = allImages[randomIndex];
                    
                    // D√©terminer la valeur √† sauvegarder
                    let valueToSave;
                    if (typeof selectedImage === 'string') {
                        // Image pr√©d√©finie
                        valueToSave = selectedImage;
                    } else if (selectedImage.isCustom) {
                        // Image personnalis√©e - sauvegarder le data URL
                        valueToSave = selectedImage.dataUrl;
                    } else {
                        valueToSave = selectedImage;
                    }
                    
                    // V√©rifier si c'est diff√©rent de la configuration actuelle
                    if (currentConfiguration[level] !== valueToSave) {
                        currentConfiguration[level] = valueToSave;
                        changedLevels++;
                    }
                }
                
                // Sauvegarder et mettre √† jour l'interface
                saveConfiguration();
                createLevelSelectors();
                updateCurrentSelection();
                
                console.log(`üé≤ Randomisation termin√©e: ${changedLevels} niveaux modifi√©s`);
                alert(`üé≤ Randomisation termin√©e !\n\n‚ú® ${changedLevels} niveaux ont √©t√© modifi√©s avec des images al√©atoires\nüìä ${allImages.length} images √©taient disponibles pour la s√©lection`);
            }
        }

        // Fonctions pour la gestion des images personnalis√©es
        function setupUploadHandlers() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('customImageInput');

            // Gestionnaire de clic sur la zone d'upload
            uploadArea.addEventListener('click', () => {
                fileInput.click();
            });

            // Gestionnaire de changement de fichier
            fileInput.addEventListener('change', (e) => {
                handleFileSelection(e.target.files);
            });

            // Gestionnaires de drag & drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileSelection(e.dataTransfer.files);
            });
        }

        function selectCustomImages() {
            document.getElementById('customImageInput').click();
        }

        function handleFileSelection(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    addCustomImage(file);
                } else {
                    alert(`Le fichier "${file.name}" n'est pas une image valide`);
                }
            });
        }

        // Fonction pour convertir et redimensionner l'image en PNG 640x640
        function processImageToPNG640(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // D√©finir les dimensions du canvas √† 640x640
                    canvas.width = 640;
                    canvas.height = 640;
                    
                    // Calculer les dimensions pour maintenir le ratio tout en remplissant le carr√©
                    const sourceRatio = img.width / img.height;
                    let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                    
                    if (sourceRatio > 1) {
                        // Image plus large que haute
                        drawHeight = 640;
                        drawWidth = 640 * sourceRatio;
                        offsetX = -(drawWidth - 640) / 2;
                    } else {
                        // Image plus haute que large
                        drawWidth = 640;
                        drawHeight = 640 / sourceRatio;
                        offsetY = -(drawHeight - 640) / 2;
                    }
                    
                    // Remplir le fond en blanc (optionnel)
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, 640, 640);
                    
                    // Dessiner l'image redimensionn√©e
                    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                    
                    // Convertir en PNG et retourner le data URL
                    const dataUrl = canvas.toDataURL('image/png', 1.0);
                    resolve(dataUrl);
                };
                
                img.onerror = function() {
                    reject(new Error('Impossible de charger l\'image'));
                };
                
                // Charger l'image depuis le fichier
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    reject(new Error('Impossible de lire le fichier'));
                };
                reader.readAsDataURL(file);
            });
        }

        function showProcessingIndicator() {
            document.getElementById('processingIndicator').style.display = 'block';
        }

        function hideProcessingIndicator() {
            document.getElementById('processingIndicator').style.display = 'none';
        }

        async function addCustomImage(file) {
            try {
                showProcessingIndicator();
                
                // Traiter l'image pour la convertir en PNG 640x640
                const processedDataUrl = await processImageToPNG640(file);
                
                const timestamp = Date.now();
                const baseName = file.name.replace(/\.[^/.]+$/, ''); // Enlever l'extension
                const customImage = {
                    name: `custom_${timestamp}_${baseName}.png`,
                    originalName: file.name,
                    dataUrl: processedDataUrl,
                    size: Math.round(processedDataUrl.length * 0.75), // Estimation de la taille
                    type: 'image/png',
                    timestamp: timestamp,
                    dimensions: '640x640'
                };

                // V√©rifier si l'image existe d√©j√† (par nom original)
                const exists = customImages.some(img =>
                    img.originalName === file.name
                );

                if (exists) {
                    hideProcessingIndicator();
                    if (confirm(`L'image "${file.name}" existe d√©j√†. Voulez-vous la remplacer ?`)) {
                        // Supprimer l'ancienne version
                        const existingIndex = customImages.findIndex(img => img.originalName === file.name);
                        if (existingIndex !== -1) {
                            customImages.splice(existingIndex, 1);
                        }
                    } else {
                        return;
                    }
                }

                customImages.push(customImage);
                saveCustomImages();
                createCustomImagesDisplay();
                createLevelSelectors(); // Recr√©er les s√©lecteurs pour inclure la nouvelle image
                
                hideProcessingIndicator();
                console.log(`Image personnalis√©e ajout√©e: ${customImage.name} (640x640 PNG)`);
                
                // Notification de succ√®s
                alert(`‚úÖ Image "${file.name}" convertie et ajout√©e avec succ√®s !\nüìê Dimensions: 640x640 pixels\nüñºÔ∏è Format: PNG`);
                
            } catch (error) {
                hideProcessingIndicator();
                console.error('Erreur lors du traitement de l\'image:', error);
                alert(`‚ùå Erreur lors du traitement de l'image "${file.name}": ${error.message}`);
            }
        }

        function deleteCustomImage(index) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette image ?')) {
                const deletedImage = customImages[index];
                
                // V√©rifier si cette image est utilis√©e dans la configuration
                let isUsed = false;
                for (let level = 1; level <= 13; level++) {
                    if (currentConfiguration[level] === deletedImage.name) {
                        currentConfiguration[level] = defaultConfiguration[level];
                        isUsed = true;
                    }
                }

                customImages.splice(index, 1);
                saveCustomImages();
                
                if (isUsed) {
                    saveConfiguration();
                    alert('Image supprim√©e. Les niveaux qui l\'utilisaient ont √©t√© r√©initialis√©s.');
                }
                
                createCustomImagesDisplay();
                createLevelSelectors();
                updateCurrentSelection();
                
                console.log(`Image personnalis√©e supprim√©e: ${deletedImage.name}`);
            }
        }

        function clearAllCustomImages() {
            if (customImages.length === 0) {
                alert('Aucune image personnalis√©e √† supprimer');
                return;
            }

            if (confirm(`√ätes-vous s√ªr de vouloir supprimer toutes les ${customImages.length} images personnalis√©es ?`)) {
                // R√©initialiser la configuration pour les images personnalis√©es utilis√©es
                let resetCount = 0;
                for (let level = 1; level <= 13; level++) {
                    const isCustomImage = customImages.some(img => img.name === currentConfiguration[level]);
                    if (isCustomImage) {
                        currentConfiguration[level] = defaultConfiguration[level];
                        resetCount++;
                    }
                }

                customImages = [];
                saveCustomImages();
                
                if (resetCount > 0) {
                    saveConfiguration();
                    alert(`Toutes les images personnalis√©es ont √©t√© supprim√©es. ${resetCount} niveaux ont √©t√© r√©initialis√©s.`);
                } else {
                    alert('Toutes les images personnalis√©es ont √©t√© supprim√©es.');
                }
                
                createCustomImagesDisplay();
                createLevelSelectors();
                updateCurrentSelection();
            }
        }

        // Fonction pour valider la configuration avec les images personnalis√©es
        function validateConfiguration() {
            const allImages = getAllAvailableImages();
            let hasChanges = false;
            
            for (let level = 1; level <= 13; level++) {
                if (!allImages.includes(currentConfiguration[level])) {
                    console.warn(`Image ${currentConfiguration[level]} non disponible pour le niveau ${level}, r√©initialisation`);
                    currentConfiguration[level] = defaultConfiguration[level];
                    hasChanges = true;
                }
            }
            
            if (hasChanges) {
                saveConfiguration();
                updateCurrentSelection();
            }
        }

        // Exposer la configuration pour l'application principale
        window.getImageConfiguration = function() {
            return currentConfiguration;
        };

        // Exposer les images personnalis√©es pour l'application principale
        window.getCustomImages = function() {
            return customImages;
        };

// === FONCTIONNALIT√âS DE SUPPRESSION DE FOND (JavaScript pur) ===

// Variables pour la suppression de fond
let backgroundRemovalEnabled = false;
let backgroundRemovalMethod = 'smart';

// Basculer la suppression de fond
function toggleBackgroundRemoval() {
    const button = document.getElementById('bgRemovalToggle');
    
    if (!backgroundRemovalEnabled) {
        backgroundRemovalEnabled = true;
        button.textContent = 'üé≠ Suppression de fond: ON';
        button.style.background = 'linear-gradient(45deg, #4caf50, #8bc34a)';
        alert('‚úÖ Suppression de fond activ√©e !\nLes nouvelles images upload√©es auront leur fond supprim√© automatiquement.\n\nüéØ M√©thodes disponibles:\n‚Ä¢ D√©tection de motifs quadrill√©s\n‚Ä¢ Suppression de fonds uniformes\n‚Ä¢ Analyse des couleurs de bord');
    } else {
        backgroundRemovalEnabled = false;
        button.textContent = 'üé≠ Suppression de fond: OFF';
        button.style.background = 'linear-gradient(45deg, #9c27b0, #e91e63)';
        alert('üîÑ Suppression de fond d√©sactiv√©e.');
    }
}

// Supprimer le fond d'une image (JavaScript pur)
function removeImageBackground(canvas) {
    if (!backgroundRemovalEnabled) {
        return canvas;
    }
    
    console.log('üé® Suppression du fond en cours (JavaScript)...');
    
    const ctx = canvas.getContext('2d');
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;
    const width = canvas.width;
    const height = canvas.height;
    
    // Cr√©er une copie pour le traitement
    const processedData = new Uint8ClampedArray(data);
    
    // 1. D√©tecter et supprimer les motifs quadrill√©s
    removeCheckeredPattern(processedData, width, height);
    
    // 2. Supprimer les fonds uniformes bas√©s sur les bords
    removeUniformBackground(processedData, width, height);
    
    // 3. Nettoyer les pixels isol√©s
    cleanIsolatedPixels(processedData, width, height);
    
    // Appliquer les modifications
    const newImageData = new ImageData(processedData, width, height);
    ctx.putImageData(newImageData, 0, 0);
    
    console.log('‚úÖ Fond supprim√© avec succ√®s (JavaScript)');
    return canvas;
}

// D√©tecter et supprimer les motifs quadrill√©s
function removeCheckeredPattern(data, width, height) {
    const blockSize = 8; // Taille des blocs √† analyser
    const tolerance = 30; // Tol√©rance de couleur
    
    for (let y = 0; y < height - blockSize; y += blockSize) {
        for (let x = 0; x < width - blockSize; x += blockSize) {
            if (isCheckeredBlock(data, x, y, blockSize, width, tolerance)) {
                // Marquer ce bloc comme transparent
                for (let by = y; by < y + blockSize && by < height; by++) {
                    for (let bx = x; bx < x + blockSize && bx < width; bx++) {
                        const index = (by * width + bx) * 4;
                        data[index + 3] = 0; // Alpha = 0 (transparent)
                    }
                }
            }
        }
    }
}

// V√©rifier si un bloc a un motif quadrill√©
function isCheckeredBlock(data, startX, startY, blockSize, width, tolerance) {
    const colors = [];
    const colorCounts = {};
    
    // Collecter les couleurs du bloc
    for (let y = startY; y < startY + blockSize; y++) {
        for (let x = startX; x < startX + blockSize; x++) {
            if (x < width && y < width) {
                const index = (y * width + x) * 4;
                const color = `${data[index]},${data[index + 1]},${data[index + 2]}`;
                colors.push(color);
                colorCounts[color] = (colorCounts[color] || 0) + 1;
            }
        }
    }
    
    // Un motif quadrill√© a g√©n√©ralement 2 couleurs dominantes
    const uniqueColors = Object.keys(colorCounts);
    if (uniqueColors.length !== 2) {
        return false;
    }
    
    // V√©rifier l'alternance des couleurs
    const color1 = uniqueColors[0];
    const color2 = uniqueColors[1];
    let alternatingCount = 0;
    let totalChecks = 0;
    
    for (let y = startY; y < startY + blockSize - 1; y++) {
        for (let x = startX; x < startX + blockSize - 1; x++) {
            if (x < width && y < width) {
                const index1 = (y * width + x) * 4;
                const index2 = ((y + 1) * width + (x + 1)) * 4;
                
                const currentColor = `${data[index1]},${data[index1 + 1]},${data[index1 + 2]}`;
                const diagonalColor = `${data[index2]},${data[index2 + 1]},${data[index2 + 2]}`;
                
                if ((currentColor === color1 && diagonalColor === color2) ||
                    (currentColor === color2 && diagonalColor === color1)) {
                    alternatingCount++;
                }
                totalChecks++;
            }
        }
    }
    
    // Si plus de 60% des v√©rifications montrent une alternance, c'est probablement un motif quadrill√©
    return totalChecks > 0 && (alternatingCount / totalChecks) > 0.6;
}

// Supprimer les fonds uniformes bas√©s sur les couleurs de bord
function removeUniformBackground(data, width, height) {
    const tolerance = 25;
    const borderColors = [];
    
    // √âchantillonner les bords
    for (let x = 0; x < width; x++) {
        // Bord sup√©rieur
        let index = x * 4;
        borderColors.push([data[index], data[index + 1], data[index + 2]]);
        
        // Bord inf√©rieur
        index = ((height - 1) * width + x) * 4;
        borderColors.push([data[index], data[index + 1], data[index + 2]]);
    }
    
    for (let y = 0; y < height; y++) {
        // Bord gauche
        let index = (y * width) * 4;
        borderColors.push([data[index], data[index + 1], data[index + 2]]);
        
        // Bord droit
        index = (y * width + (width - 1)) * 4;
        borderColors.push([data[index], data[index + 1], data[index + 2]]);
    }
    
    // Trouver la couleur la plus commune
    const colorCounts = {};
    borderColors.forEach(color => {
        const key = `${color[0]},${color[1]},${color[2]}`;
        colorCounts[key] = (colorCounts[key] || 0) + 1;
    });
    
    const mostCommonColor = Object.keys(colorCounts).reduce((a, b) =>
        colorCounts[a] > colorCounts[b] ? a : b
    );
    
    const [bgR, bgG, bgB] = mostCommonColor.split(',').map(Number);
    
    // Supprimer cette couleur de fond
    for (let i = 0; i < data.length; i += 4) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        if (Math.abs(r - bgR) <= tolerance &&
            Math.abs(g - bgG) <= tolerance &&
            Math.abs(b - bgB) <= tolerance) {
            data[i + 3] = 0; // Rendre transparent
        }
    }
}

// Nettoyer les pixels isol√©s (anti-aliasing)
function cleanIsolatedPixels(data, width, height) {
    const newData = new Uint8ClampedArray(data);
    
    for (let y = 1; y < height - 1; y++) {
        for (let x = 1; x < width - 1; x++) {
            const index = (y * width + x) * 4;
            
            if (data[index + 3] > 0) { // Si le pixel n'est pas transparent
                // V√©rifier les 8 pixels voisins
                let transparentNeighbors = 0;
                
                for (let dy = -1; dy <= 1; dy++) {
                    for (let dx = -1; dx <= 1; dx++) {
                        if (dx === 0 && dy === 0) continue;
                        
                        const neighborIndex = ((y + dy) * width + (x + dx)) * 4;
                        if (data[neighborIndex + 3] === 0) {
                            transparentNeighbors++;
                        }
                    }
                }
                
                // Si plus de 6 voisins sur 8 sont transparents, rendre ce pixel transparent aussi
                if (transparentNeighbors >= 6) {
                    newData[index + 3] = 0;
                }
            }
        }
    }
    
    // Copier les modifications
    for (let i = 0; i < data.length; i++) {
        data[i] = newData[i];
    }
}
        
        // Nouvelle fonction processImageToPNG640 avec suppression de fond int√©gr√©e
        function processImageToPNG640WithBackgroundRemoval(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // D√©finir les dimensions du canvas √† 640x640
                    canvas.width = 640;
                    canvas.height = 640;
                    
                    // Calculer les dimensions pour maintenir le ratio tout en remplissant le carr√©
                    const sourceRatio = img.width / img.height;
                    let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
                    
                    if (sourceRatio > 1) {
                        // Image plus large que haute
                        drawHeight = 640;
                        drawWidth = 640 * sourceRatio;
                        offsetX = -(drawWidth - 640) / 2;
                    } else {
                        // Image plus haute que large
                        drawWidth = 640;
                        drawHeight = 640 / sourceRatio;
                        offsetY = -(drawHeight - 640) / 2;
                    }
                    
                    // Remplir le fond en blanc (optionnel)
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, 640, 640);
                    
                    // Dessiner l'image redimensionn√©e
                    ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                    
                    // Supprimer le fond si activ√©
                    if (backgroundRemovalEnabled) {
                        console.log('üé® Application de la suppression de fond...');
                        removeImageBackground(canvas);
                    }
                    
                    // Convertir en PNG et retourner le data URL
                    const dataUrl = canvas.toDataURL('image/png', 1.0);
                    resolve(dataUrl);
                };
                
                img.onerror = function() {
                    reject(new Error('Impossible de charger l\'image'));
                };
                
                // Charger l'image depuis le fichier
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                };
                reader.onerror = function() {
                    reject(new Error('Impossible de lire le fichier'));
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Nouvelle version de addCustomImage avec suppression de fond JavaScript
        async function addCustomImageWithBackgroundRemoval(file) {
            try {
                showProcessingIndicator();
                
                // Mettre √† jour l'indicateur si la suppression de fond est activ√©e
                if (backgroundRemovalEnabled) {
                    const processingDiv = document.getElementById('processingIndicator');
                    if (processingDiv) {
                        processingDiv.innerHTML = `
                            <div class="spinner"></div>
                            <div>Conversion et suppression de fond...</div>
                            <div style="font-size: 12px; margin-top: 10px;">D√©tection de motifs quadrill√©s</div>
                        `;
                    }
                }
                
                // Traiter l'image avec suppression de fond int√©gr√©e
                const finalDataUrl = await processImageToPNG640WithBackgroundRemoval(file);
                
                const timestamp = Date.now();
                const baseName = file.name.replace(/\.[^/.]+$/, ''); // Enlever l'extension
                const customImage = {
                    name: `custom_${timestamp}_${baseName}.png`,
                    originalName: file.name,
                    dataUrl: finalDataUrl,
                    size: Math.round(finalDataUrl.length * 0.75), // Estimation de la taille
                    type: 'image/png',
                    timestamp: timestamp,
                    dimensions: '640x640',
                    backgroundRemoved: backgroundRemovalEnabled
                };

                // V√©rifier si l'image existe d√©j√† (par nom original)
                const exists = customImages.some(img =>
                    img.originalName === file.name
                );

                if (exists) {
                    hideProcessingIndicator();
                    if (confirm(`L'image "${file.name}" existe d√©j√†. Voulez-vous la remplacer ?`)) {
                        // Supprimer l'ancienne version
                        const existingIndex = customImages.findIndex(img => img.originalName === file.name);
                        if (existingIndex !== -1) {
                            customImages.splice(existingIndex, 1);
                        }
                    } else {
                        return;
                    }
                }

                customImages.push(customImage);
                saveCustomImages();
                createCustomImagesDisplay();
                createLevelSelectors(); // Recr√©er les s√©lecteurs pour inclure la nouvelle image
                
                hideProcessingIndicator();
                console.log(`Image personnalis√©e ajout√©e: ${customImage.name} (640x640 PNG, fond supprim√©: ${backgroundRemovalEnabled})`);
                
                // Notification de succ√®s
                const bgStatus = backgroundRemovalEnabled ? 'üé≠ Fond supprim√© (JavaScript)' : 'üñºÔ∏è Fond conserv√©';
                alert(`‚úÖ Image "${file.name}" convertie et ajout√©e avec succ√®s !\nüìê Dimensions: 640x640 pixels\nüñºÔ∏è Format: PNG\n${bgStatus}`);
                
            } catch (error) {
                hideProcessingIndicator();
                console.error('Erreur lors du traitement de l\'image:', error);
                alert(`‚ùå Erreur lors du traitement de l'image "${file.name}": ${error.message}`);
            }
        }
        
        // Remplacer la fonction addCustomImage originale
        addCustomImage = addCustomImageWithBackgroundRemoval;
        // Valider la configuration au chargement
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(validateConfiguration, 100);
            console.log('‚úÖ Suppression de fond JavaScript int√©gr√©e et pr√™te');
        });
    </script>